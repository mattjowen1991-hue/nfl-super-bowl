<!DOCTYPE html>
<html lang="en">
<head>
  <!-- PWA Support -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#facc15">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SB League">
<link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸˆ Super Bowl LX â€” Elimination League</title>
  <link rel="icon" type="image/png" sizes="48x48" href="Assets/nfl-favicon2.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preload" as="image" href="Assets/football-field.jpeg" />

  <style>
  /* ---------------- Fonts & base ---------------- */
  @font-face {
    font-family: 'Freshman';
    src: url('Assets/Freshman.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }

  html { height: 100%; background:#000; }
  body {
    height: 100%;
    min-height: 100dvh;
    background: transparent;
    overscroll-behavior: none;
  }

  /* Fixed background */
  .site-bg {
    position: fixed;
    top: 0; left: 0;
    width: 100lvw;
    height: 100lvh;
    z-index: -1;
    pointer-events: none;
    background:
      linear-gradient(to bottom, rgba(0,0,0,.72), rgba(0,0,0,.62), rgba(0,0,0,.86)),
      url('Assets/football-field.jpeg');
    background-position: center center, center center;
    background-size: cover, cover;
    background-repeat: no-repeat, no-repeat;
    backface-visibility: hidden;
    will-change: transform;
    transform: translateZ(0);
  }
  @supports not (height: 100lvh) {
    .site-bg { width: 100dvw; height: 100dvh; }
  }
  @supports not (height: 100dvh) {
    .site-bg { width: 100vw; height: 100vh; }
  }

  /* Card hover */
  .card-hover { transition: transform .15s ease, box-shadow .15s ease; }
  .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 24px rgba(0,0,0,.35); }

  /* ---------------- Team Status Animations ---------------- */
  
  /* Alive - green glow */
  .team-alive {
    color: #5bff8a;
    text-shadow: 0 0 6px rgba(0,255,120,.9), 0 0 14px rgba(0,255,120,.6), 0 0 24px rgba(0,255,120,.4);
    animation: neonPulseG 1.2s ease-in-out infinite;
  }
  @keyframes neonPulseG {
    0%   { text-shadow: 0 0 4px rgba(0,255,120,.5), 0 0 8px rgba(0,255,120,.4), 0 0 16px rgba(0,255,120,.2); }
    50%  { text-shadow: 0 0 10px rgba(0,255,120,1), 0 0 22px rgba(0,255,120,.8), 0 0 36px rgba(0,255,120,.6); }
    100% { text-shadow: 0 0 4px rgba(0,255,120,.5), 0 0 8px rgba(0,255,120,.4), 0 0 16px rgba(0,255,120,.2); }
  }

  /* Eliminated - fiery red glow */
  .team-eliminated {
    color: #ff4444;
    text-decoration: line-through;
    text-shadow: 0 0 8px rgba(255,69,0,.9), 0 0 16px rgba(255,69,0,.7), 0 0 24px rgba(255,165,0,.5);
    animation: firePulse 0.8s ease-in-out infinite;
  }
  @keyframes firePulse {
    0%   { text-shadow: 0 0 6px rgba(255,69,0,.6), 0 0 12px rgba(255,69,0,.4), 0 0 20px rgba(255,165,0,.3); }
    25%  { text-shadow: 0 0 10px rgba(255,100,0,.9), 0 0 20px rgba(255,69,0,.7), 0 0 30px rgba(255,165,0,.5); }
    50%  { text-shadow: 0 0 14px rgba(255,165,0,1), 0 0 28px rgba(255,69,0,.8), 0 0 40px rgba(255,100,0,.6); }
    75%  { text-shadow: 0 0 10px rgba(255,69,0,.9), 0 0 20px rgba(255,100,0,.7), 0 0 30px rgba(255,165,0,.5); }
    100% { text-shadow: 0 0 6px rgba(255,69,0,.6), 0 0 12px rgba(255,69,0,.4), 0 0 20px rgba(255,165,0,.3); }
  }

  /* TBC - muted */
  .team-tbc {
    color: #666;
    font-style: italic;
  }

  /* Player eliminated badge */
  .eliminated-badge {
    background: linear-gradient(135deg, #ff4444, #ff6600);
    color: white;
    font-family: 'Freshman', sans-serif;
    font-size: 0.5rem;
    padding: 1px 4px;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    animation: badgePulse 1.5s ease-in-out infinite;
    white-space: nowrap;
    display: block;
    width: fit-content;
    margin-top: 2px;
  }
  @keyframes badgePulse {
    0%, 100% { box-shadow: 0 0 8px rgba(255,69,0,.6); }
    50% { box-shadow: 0 0 16px rgba(255,69,0,.9), 0 0 24px rgba(255,165,0,.5); }
  }

  /* Player row when eliminated */
  .player-eliminated {
    opacity: 0.7;
  }

  /* ---------------- Panels ---------------- */
  .panel-yellow { 
    background: rgba(0,0,0,.72); 
    border: 1px solid rgba(255,204,0,.6); 
    border-radius: 16px; 
  }
  .y-divider > * + * { border-left: 1px solid rgba(255,204,0,.55); }

  /* Winner glow */
  .winner-glow {
    animation: winPulse 1.4s ease-in-out infinite;
    filter: drop-shadow(0 0 7px rgba(250,204,21,.95)) drop-shadow(0 0 18px rgba(250,204,21,.55));
  }
  @keyframes winPulse {
    0%   { transform: scale(1); }
    50%  { transform: scale(1.06); }
    100% { transform: scale(1); }
  }

  /* Hall of Fame glow */
  .ice-glow {
    animation: icePulse 1.6s ease-in-out infinite;
    filter: drop-shadow(0 0 7px rgba(125,211,252,.95)) drop-shadow(0 0 18px rgba(56,189,248,.65));
  }
  @keyframes icePulse { 
    0%   { transform: scale(1); } 
    50%  { transform: scale(1.05); } 
    100% { transform: scale(1); } 
  }

  /* Spoon wobble */
  .spoon-wobble {
    animation: wob 1.8s ease-in-out infinite;
    filter: drop-shadow(0 0 4px rgba(255,99,132,.8)) drop-shadow(0 0 12px rgba(255,99,132,.5));
  }
  @keyframes wob { 
    0%,100% { transform: rotate(0deg); } 
    25% { transform: rotate(2deg); } 
    75% { transform: rotate(-2deg); } 
  }

    /* ---------------- Prize Pot Styles ---------------- */
  .prize-pot-section {
    margin-bottom: 1.5rem;
  }
  
  .prize-pot-container {
    position: relative;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
    border: 2px solid #d4af37;
    border-radius: 1.5rem;
    padding: 2rem;
    overflow: hidden;
    box-shadow: 
      0 0 30px rgba(212, 175, 55, 0.3),
      inset 0 0 60px rgba(0, 0, 0, 0.5);
  }
  
  .prize-pot-container::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
      from 0deg,
      transparent 0deg,
      rgba(212, 175, 55, 0.1) 60deg,
      transparent 120deg
    );
    animation: rotateBg 10s linear infinite;
    pointer-events: none;
  }
  
  @keyframes rotateBg {
    to { transform: rotate(360deg); }
  }
  
  .prize-pot-inner {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }
  
  .trophy-icon {
    font-size: 4rem;
    filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.8));
    animation: trophyBounce 2s ease-in-out infinite;
  }
  
  @keyframes trophyBounce {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-10px) scale(1.05); }
  }
  
  .prize-label {
    font-family: 'Freshman', sans-serif;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: rgba(255, 255, 255, 0.7);
  }
  
  .prize-amount {
    font-family: 'Freshman', sans-serif;
    font-size: 3.5rem;
    font-weight: 900;
    background: linear-gradient(135deg, #ffd700, #ffec8b, #ffd700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    animation: amountPulse 3s ease-in-out infinite;
  }
  
  @keyframes amountPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.02); opacity: 0.9; }
  }
  
  .prize-subtitle {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 0.15em;
  }

  .champion-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .champion-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid #d4af37;
    object-fit: cover;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
    animation: avatarPulse 2s ease-in-out infinite;
  }

  @keyframes avatarPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(212, 175, 55, 0.6); }
    50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(212, 175, 55, 0.9); }
  }

  .winning-team-logo {
    width: 60px;
    height: 60px;
    object-fit: contain;
    filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
  }
  
  .money-rain {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 0;
  }
  
  .money {
    position: absolute;
    top: -50px;
    font-size: 1.5rem;
    opacity: 0.6;
    animation: fall linear infinite;
  }
  
  @keyframes fall {
    0% { transform: translateY(-50px) rotate(0deg); opacity: 0.8; }
    100% { transform: translateY(300px) rotate(360deg); opacity: 0; }
  }
  
  .money:nth-child(1) { left: 10%; animation-duration: 3s; animation-delay: 0s; }
  .money:nth-child(2) { left: 25%; animation-duration: 3.5s; animation-delay: 0.5s; }
  .money:nth-child(3) { left: 40%; animation-duration: 2.8s; animation-delay: 1s; }
  .money:nth-child(4) { left: 55%; animation-duration: 3.2s; animation-delay: 0.3s; }
  .money:nth-child(5) { left: 70%; animation-duration: 3.7s; animation-delay: 0.8s; }
  .money:nth-child(6) { left: 85%; animation-duration: 3s; animation-delay: 1.2s; }
  .money:nth-child(7) { left: 5%; animation-duration: 3.3s; animation-delay: 1.5s; }
  .money:nth-child(8) { left: 95%; animation-duration: 2.9s; animation-delay: 0.2s; }

  /* ---------------- Table styling ---------------- */
  .picks-clean {
    background: rgba(0,0,0,.72);
    border: 1px solid rgba(255,204,0,.6);
    border-radius: 16px;
  }
  .table-grid {
    width: 100%;
    background: transparent;
    border-collapse: separate;
    border-spacing: 0;
  }
  .table-grid thead tr { background: rgba(255,204,0,.08); }
  .table-grid th, .table-grid td {
    font-family: 'Freshman', ui-sans-serif, system-ui;
    letter-spacing: .02em;
    padding: 12px 16px;
    border-right: 1px solid rgba(255,204,0,.55);
    border-bottom: 1px solid rgba(255,204,0,.55);
  }
  .table-grid th { color: #facc15; font-weight: 800; }
  .table-grid tr:last-child td { border-bottom: 0; }
  .table-grid th:last-child, .table-grid td:last-child { border-right: 0; }

  /* ---------------- Mobile Responsive ---------------- */
  @media (max-width: 640px) {
  .table-grid th, .table-grid td {
    padding: 8px 4px;
    font-size: 0.75rem;
    text-align: center;
  }
  .table-grid td:first-child {
    text-align: left;
    max-width: 90px;
  }
  .table-grid td:first-child .font-semibold {
    font-size: 0.7rem;
  }
    .table-grid .team-logo-small {
      width: 20px;
      height: 20px;
    }
    .header-title {
      font-size: 1.5rem !important;
    }
    .header-subtitle {
      font-size: 1.3rem !important;
    }
    .panel-yellow {
      padding: 12px !important;
    }
    .highlight-avatar {
      width: 48px !important;
      height: 48px !important;
    }
    .highlight-name {
      font-size: 0.95rem !important;
    }
    .hof-avatar {
      width: 40px !important;
      height: 40px !important;
    }
    .mobile-stack {
      grid-template-columns: 1fr !important;
    }

    .prize-amount {
      font-size: 2.5rem;
    }
    .trophy-icon {
      font-size: 3rem;
    }
    .prize-pot-container {
      padding: 1.5rem;
    }
    .champion-avatar {
      width: 60px;
      height: 60px;
    }
    .winning-team-logo {
      width: 40px;
      height: 40px;
    }
    .mobile-divider > * + * {
      border-left: 1px solid rgba(255,204,0,.55) !important;
      border-top: none;
      padding-top: 0;
      margin-top: 0;
    }
    
    /* Center the Season Highlights content on mobile */
    .mobile-divider > div {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .mobile-divider .flex.items-center {
      justify-content: center;
    }
  }

  /* Loading spinner */
  .spinner {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid rgba(255,204,0,.3);
    border-top-color: #facc15;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Status indicator */
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
  }
  .status-live { background: #5bff8a; box-shadow: 0 0 8px rgba(0,255,120,.8); }
  .status-updating { background: #facc15; animation: pulse 1s infinite; }

  @media (prefers-reduced-motion: reduce) {
    .team-alive, .team-eliminated, .ice-glow, .spoon-wobble, .winner-glow, .eliminated-badge { 
      animation: none; 
    }
  }
  </style>
</head>

<body class="min-h-screen text-white relative">
  <!-- Background layer -->
  <div class="site-bg" aria-hidden="true"></div>

  <!-- Header -->
  <header class="max-w-6xl mx-auto px-4 sm:px-6 py-4 sm:py-6">
    <div class="text-center">
      <h1 class="font-black tracking-tight leading-tight" style="font-family: Freshman, ui-sans-serif, system-ui">
        <span class="block text-2xl sm:text-5xl header-title">Super Bowl LX</span>
        <span class="block text-xl sm:text-4xl header-subtitle">Elimination League</span>
      </h1>
      <p class="mt-1 text-xs sm:text-sm text-white/80 flex items-center justify-center gap-1">
        <span>ğŸ†</span> The road to victory starts here <span>ğŸ†</span>
      </p>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 pb-24">

    <!-- Prize Pot / Champion Section -->
    <section id="prizePotSection" class="prize-pot-section">
      <div class="prize-pot-container">
        <div class="money-rain">
          <span class="money">ğŸ’µ</span>
          <span class="money">ğŸˆ</span>
          <span class="money">ğŸ’°</span>
          <span class="money">ğŸˆ</span>
          <span class="money">ğŸ’·</span>
          <span class="money">ğŸˆ</span>
          <span class="money">ğŸ’µ</span>
          <span class="money">ğŸˆ</span>
        </div>
        <div id="prizePotInner" class="prize-pot-inner">
          <!-- Will be populated by JS -->
          <div class="trophy-icon">ğŸ†</div>
          <div class="prize-label">Prize Pot</div>
          <div class="prize-amount">Â£35</div>
          <div class="prize-subtitle">7 Players Ã— Â£5 Entry</div>
        </div>
      </div>
    </section>
    
    <!-- Status Bar -->
    <div class="flex items-center justify-between mb-4 text-xs text-white/60">
      <div class="flex items-center gap-2">
        <span class="status-dot status-live"></span>
        <span id="statusText">Live</span>
      </div>
      <div id="lastUpdated">Loading playoff data...</div>
    </div>

    <!-- Player Picks Table -->
    <section id="picksSection" class="card-hover rounded-2xl p-4 sm:p-6 mb-6 picks-clean">
      <h2 class="text-lg sm:text-2xl font-bold mb-4" style="font-family: Freshman">Player Picks</h2>
      
      <!-- Loading State -->
      <div id="loadingState" class="text-center py-8">
        <div class="spinner mx-auto mb-3"></div>
        <p class="text-white/60">Loading picks...</p>
      </div>
      
      <!-- Table -->
      <div id="tableContainer" class="overflow-x-auto hidden">
        <table class="min-w-full border-separate border-spacing-0 table-grid">
          <thead>
            <tr>
              <th class="text-left">Player</th>
              <th class="text-center">
                <div class="flex items-center gap-1 sm:gap-2 justify-center">
                  <img src="Assets/afc.png" class="w-6 h-6 sm:w-10 sm:h-10" alt="AFC" />
                  <span class="hidden sm:inline">AFC Team</span>
                  <span class="sm:hidden">AFC</span>
                </div>
              </th>
              <th class="text-center">
                <div class="flex items-center gap-1 sm:gap-2 justify-center">
                  <img src="Assets/nfc.png" class="w-4 h-4 sm:w-5 sm:h-5" alt="NFC" />
                  <span class="hidden sm:inline">NFC Team</span>
                  <span class="sm:hidden">NFC</span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody id="playerPicksBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Season Highlight & Hall of Fame -->
    <section class="grid md:grid-cols-2 gap-4 md:gap-6 mt-6 mobile-stack">
      <!-- Season Highlight -->
      <div class="panel-yellow card-hover p-4 sm:p-6">
        <h2 class="text-lg sm:text-2xl font-bold mb-4" style="font-family: Freshman">Season Highlights</h2>
        <div class="grid grid-cols-2 y-divider mobile-divider">
          <div class="pr-3">
            <p class="text-amber-400 font-semibold mb-2 text-sm sm:text-base">Winner ğŸ¥‡</p>
            <div class="flex items-center gap-2 sm:gap-3">
              <img id="seasonWinnerAvatar" src="Assets/winnertbc.png" alt="Winner avatar"
                   class="winner-glow w-12 h-12 sm:w-14 sm:h-14 highlight-avatar rounded-full ring-2 ring-amber-400 object-cover" />
              <div>
                <div id="seasonWinnerName" class="text-base sm:text-lg highlight-name font-bold">TBD</div>
                <div id="seasonWinnerTeam" class="text-xs text-white/60">â€”</div>
              </div>
            </div>
          </div>
          <div class="pl-3">
            <p class="text-rose-400 font-semibold mb-2 text-sm sm:text-base">Spooner ğŸ¥„</p>
            <div class="flex items-center gap-2 sm:gap-3">
              <img id="seasonSpoonAvatar" src="Assets/losertbc.png" alt="Spoon avatar"
                   class="spoon-wobble w-12 h-12 sm:w-14 sm:h-14 highlight-avatar rounded-full ring-2 ring-rose-400 object-cover" />
              <div>
                <div id="seasonSpoonName" class="text-base sm:text-lg highlight-name font-bold">TBD</div>
                <div id="seasonSpoonTeam" class="text-xs text-white/60">â€”</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hall of Fame -->
      <div class="panel-yellow card-hover p-4 sm:p-6">
        <h2 class="text-lg sm:text-2xl font-bold mb-4" style="font-family: Freshman">Hall of Fame</h2>
        <div id="hallOfFame" class="grid grid-cols-3 sm:grid-cols-4 gap-2 sm:gap-3"></div>
      </div>
    </section>
  </main>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    // ESPN scoreboard endpoint - we'll fetch multiple weeks
    const ESPN_BASE_URL = 'https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard';
    
    // JSONBin config - auto-syncs with Draft Machine
    const JSONBIN_BIN_ID = '695b078fd0ea881f4054b2a0';
    const JSONBIN_API_KEY = '$2a$10$C7BY0Kl0u74gNn/kXO7xNuayWv493/f1jAxlHUmx3ENADQKDii61C';

    // Prize pot configuration
    const ENTRY_FEE = 5; // Â£5 per player
    
    // Elimination order tracking (for spooner detection)
    // Format: Array of { round: 'Wild Card', teams: ['Team1', 'Team2'] }
    const ELIMINATION_ORDER = [
      { round: 'Wild Card', teams: ['Pittsburgh Steelers', 'Jacksonville Jaguars', 'Los Angeles Chargers', 'Carolina Panthers', 'Green Bay Packers', 'Philadelphia Eagles'] },
      // Add after Divisional: { round: 'Divisional', teams: ['Team1', 'Team2'] },
      // Add after Conference: { round: 'Conference', teams: ['Team1', 'Team2'] },
      // Add after Super Bowl: { round: 'Super Bowl', teams: ['LosingTeam'] },
    ];
    
    // ============================================
    // KNOWN ELIMINATED TEAMS (FALLBACK)
    // Updated manually as backup - ESPN API sometimes doesn't return past weeks
    // ============================================
    const KNOWN_ELIMINATED_TEAMS = [
      // Wild Card Round Losers (Jan 10-12, 2026)
      'Pittsburgh Steelers',    // Lost to Texans 6-30
      'Jacksonville Jaguars',   // Lost to Bills 24-27
      'Los Angeles Chargers',   // Lost to Patriots 3-16
      'Carolina Panthers',      // Lost to Rams 31-34
      'Green Bay Packers',      // Lost to Bears 27-31
      'Philadelphia Eagles',    // Lost to 49ers 19-23
    ];
    
    // ============================================
    // FALLBACK DATA
    // ============================================
    const fallbackPlayers = [
      { id: 'joe',   name: 'Joe',   avatar: 'Assets/joe.png',   team: 'Lions',   teamLogo: 'Assets/Lions.png' },
      { id: 'jarv',  name: 'Jarv',  avatar: 'Assets/jarv.png',  team: 'Rams',    teamLogo: 'Assets/Rams.png' },
      { id: 'matt',  name: 'Matt',  avatar: 'Assets/matt.png',  team: 'Chiefs',  teamLogo: 'Assets/Chiefs.png' },
      { id: 'gaz',   name: 'Gaz',   avatar: 'Assets/gaz.png',   team: 'Bills',   teamLogo: 'Assets/Bills.png' },
      { id: 'ben',   name: 'Ben',   avatar: 'Assets/ben.png',   team: 'Eagles',  teamLogo: 'Assets/Eagles.png' },
      { id: 'mark',  name: 'Mark',  avatar: 'Assets/mark.png',  team: 'Texans',  teamLogo: 'Assets/Texans.png' },
      { id: 'liam',  name: 'Liam',  avatar: 'Assets/liam.png',  team: 'Vikings', teamLogo: 'Assets/minnesota-vikings.png' }
    ];
    
    const fallbackConfig = {
      season: '2025',
      highlight: { winner: null, spoon: null },
      honorary: [
        { year: 2024, player: 'ben' }
      ]
    };
    
    const fallbackPicks = {
      joe:  { afcTeam: 'TBC', nfcTeam: 'TBC' },
      jarv: { afcTeam: 'TBC', nfcTeam: 'TBC' },
      matt: { afcTeam: 'TBC', nfcTeam: 'TBC' },
      gaz:  { afcTeam: 'TBC', nfcTeam: 'TBC' },
      ben:  { afcTeam: 'TBC', nfcTeam: 'TBC' },
      mark: { afcTeam: 'TBC', nfcTeam: 'TBC' },
      liam: { afcTeam: 'TBC', nfcTeam: 'TBC' }
    };

    // ============================================
    // UTILITIES
    // ============================================
    async function fetchJson(path, fallback) {
      try {
        const res = await fetch(path, { cache: 'no-store' });
        if (!res.ok) throw new Error('Fetch failed');
        return await res.json();
      } catch {
        return structuredClone(fallback);
      }
    }

    // Fetch picks from JSONBin (synced with Draft Machine)
    async function fetchPicksFromJsonBin() {
      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
          headers: { 'X-Access-Key': JSONBIN_API_KEY },
          cache: 'no-store'
        });
        
        if (!res.ok) throw new Error('JSONBin fetch failed');
        
        const data = await res.json();
        const record = data.record;
        const draftData = record?.picks || record;
        
        // Map draft machine format to league table format
        if (draftData && typeof draftData === 'object') {
          const picks = {};
          for (const [playerId, playerData] of Object.entries(draftData)) {
            if (playerData && typeof playerData === 'object' && 'afcTeam' in playerData) {
              picks[playerId] = {
                afcTeam: playerData.afcTeam || 'TBC',
                nfcTeam: playerData.nfcTeam || 'TBC'
              };
            }
          }
          console.log('âœ… Loaded picks from JSONBin:', picks);
          return picks;
        }
        
        throw new Error('Invalid data format');
      } catch (err) {
        console.warn('âš ï¸ JSONBin fetch failed, using fallback:', err);
        return structuredClone(fallbackPicks);
      }
    }

    function indexBy(arr, key = 'id') {
      const m = new Map();
      arr.forEach(o => m.set(o[key], o));
      return m;
    }

    function slugifyTeam(name) {
      return String(name).toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    }

    // ============================================
    // ESPN PLAYOFF DATA - FETCH ALL WEEKS
    // ============================================
    async function fetchEliminatedTeams() {
      const eliminated = new Set();
      let superBowlWinner = null;
      let lastUpdated = '';
      
      try {
        const weekUrls = [
          `${ESPN_BASE_URL}?seasontype=3&week=1`, // Wild Card
          `${ESPN_BASE_URL}?seasontype=3&week=2`, // Divisional
          `${ESPN_BASE_URL}?seasontype=3&week=3`, // Conference Championship
          `${ESPN_BASE_URL}?seasontype=3&week=5`, // Super Bowl
        ];
        
        const responses = await Promise.all(
          weekUrls.map(url => 
            fetch(url, { cache: 'no-store' })
              .then(res => res.ok ? res.json() : null)
              .catch(() => null)
          )
        );
        
        responses.forEach((data, index) => {
          if (!data || !data.events) return;
          
          console.log(`ğŸ“… Processing playoff week ${index + 1}: ${data.events.length} games`);
          
          data.events.forEach(event => {
            const competition = event.competitions?.[0];
            if (!competition) return;
            
            const isSuperBowl = index === 3;
            
            if (competition.status?.type?.completed) {
              competition.competitors?.forEach(team => {
                if (team.winner === false) {
                  const teamName = team.team.displayName;
                  eliminated.add(teamName);
                  console.log(`âŒ ${teamName} eliminated`);
                } else if (team.winner === true && isSuperBowl) {
                  superBowlWinner = team.team.displayName;
                  console.log(`ğŸ† Super Bowl Winner: ${superBowlWinner}`);
                }
              });
            }
          });
        });
        
        if (eliminated.size === 0) {
          console.log('âš ï¸ ESPN returned no eliminations, using known eliminated teams');
          KNOWN_ELIMINATED_TEAMS.forEach(team => eliminated.add(team));
        }
        
        lastUpdated = new Date().toLocaleString('en-GB', {
          day: '2-digit',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        return {
          eliminated: Array.from(eliminated),
          superBowlWinner,
          lastUpdated
        };
      } catch (err) {
        console.error('Error fetching ESPN data:', err);
        return { 
          eliminated: [...KNOWN_ELIMINATED_TEAMS],
          superBowlWinner: null,
          lastUpdated: 'Using cached data'
        };
      }
    }

    // ============================================
    // WINNER & SPOONER DETECTION
    // ============================================
    function detectWinnerAndSpooner(players, picks, eliminatedTeams, superBowlWinner) {
      const elim = new Set(eliminatedTeams || []);
      const results = {
        winner: null,
        winningTeam: null,
        spooner: null,
        playersAlive: [],
        playersEliminated: []
      };
      
      // Analyze each player's status
      players.forEach(p => {
        const pk = picks[p.id] || {};
        const afcTeam = pk.afcTeam || 'TBC';
        const nfcTeam = pk.nfcTeam || 'TBC';
        
        const afcIsTBC = afcTeam === 'TBC';
        const nfcIsTBC = nfcTeam === 'TBC';
        const afcElim = !afcIsTBC && elim.has(afcTeam);
        const nfcElim = !nfcIsTBC && elim.has(nfcTeam);
        
        const bothEliminated = !afcIsTBC && !nfcIsTBC && afcElim && nfcElim;
        const hasTeamAlive = (!afcIsTBC && !afcElim) || (!nfcIsTBC && !nfcElim);
        
        if (bothEliminated) {
          results.playersEliminated.push({ player: p, afcTeam, nfcTeam });
        } else if (hasTeamAlive) {
          results.playersAlive.push({
            player: p,
            afcTeam: !afcElim ? afcTeam : null,
            nfcTeam: !nfcElim ? nfcTeam : null
          });
        }
      });
      
      // Determine spooner (first player fully eliminated)
      if (results.playersEliminated.length > 0) {
        let earliestRoundIndex = Infinity;
        
        results.playersEliminated.forEach(({ player, afcTeam, nfcTeam }) => {
          const afcRound = ELIMINATION_ORDER.findIndex(r => r.teams.includes(afcTeam));
          const nfcRound = ELIMINATION_ORDER.findIndex(r => r.teams.includes(nfcTeam));
          const lastTeamRoundIndex = Math.max(
            afcRound >= 0 ? afcRound : 0,
            nfcRound >= 0 ? nfcRound : 0
          );
          
          if (lastTeamRoundIndex < earliestRoundIndex) {
            earliestRoundIndex = lastTeamRoundIndex;
            results.spooner = player;
          }
        });
      }
      
      // Determine winner
      if (superBowlWinner) {
        // Super Bowl winner detected - find player(s) who picked that team
        const winningPlayer = players.find(p => {
          const pk = picks[p.id] || {};
          return pk.afcTeam === superBowlWinner || pk.nfcTeam === superBowlWinner;
        });
        if (winningPlayer) {
          results.winner = winningPlayer;
          results.winningTeam = superBowlWinner;
        }
      } else if (results.playersAlive.length === 1) {
        // Only one player has a team still alive
        results.winner = results.playersAlive[0].player;
        results.winningTeam = results.playersAlive[0].afcTeam || results.playersAlive[0].nfcTeam;
      }
      
      console.log('ğŸ” Winner/Spooner detection:', {
        winner: results.winner?.name,
        winningTeam: results.winningTeam,
        spooner: results.spooner?.name,
        playersAlive: results.playersAlive.length,
        playersEliminated: results.playersEliminated.length
      });
      
      return results;
    }

    // ============================================
    // RENDER PRIZE POT / CHAMPION
    // ============================================
    function renderPrizePot(players, winner, winningTeam) {
      const container = document.getElementById('prizePotInner');
      const prizeAmount = players.length * ENTRY_FEE;
      
      if (winner && winningTeam) {
        // Show champion display
        const teamLogoPath = `Assets/teams/${slugifyTeam(winningTeam)}.png`;
        
        container.innerHTML = `
          <div class="trophy-icon">ğŸ‘‘</div>
          <div class="champion-row">
            <img src="${winner.avatar}" alt="${winner.name}" class="champion-avatar" 
                 onerror="this.src='Assets/winnertbc.png'">
            <div class="prize-amount">${winner.name}!</div>
          </div>
          <div class="prize-label">Super Bowl LX Champion</div>
          <div class="flex items-center gap-3 mt-2">
            <img src="${teamLogoPath}" alt="${winningTeam}" class="winning-team-logo"
                 onerror="this.style.display='none'">
            <div class="prize-subtitle">${winningTeam} ğŸ†</div>
          </div>
          <div class="text-amber-400 font-bold text-lg mt-2">Â£${prizeAmount} Won!</div>
        `;
      } else {
        // Show prize pot (no winner yet)
        container.innerHTML = `
          <div class="trophy-icon">ğŸ†</div>
          <div class="prize-label">Prize Pot</div>
          <div class="prize-amount">Â£${prizeAmount}</div>
          <div class="prize-subtitle">${players.length} Players Ã— Â£${ENTRY_FEE} Entry</div>
        `;
      }
    }

    // ============================================
    // RENDER PICKS TABLE
    // ============================================
    function renderPicks(players, picks, eliminatedTeams) {
      const tbody = document.getElementById('playerPicksBody');
      const loadingState = document.getElementById('loadingState');
      const tableContainer = document.getElementById('tableContainer');
      
      if (!tbody) return;
      
      const elim = new Set(eliminatedTeams || []);
      tbody.innerHTML = '';

      players.forEach(p => {
        const pk = picks[p.id] || {};
        const afcTeam = pk.afcTeam || 'TBC';
        const nfcTeam = pk.nfcTeam || 'TBC';
        
        const afcIsTBC = afcTeam === 'TBC';
        const nfcIsTBC = nfcTeam === 'TBC';
        const afcElim = !afcIsTBC && elim.has(afcTeam);
        const nfcElim = !nfcIsTBC && elim.has(nfcTeam);
        
        // Player is eliminated if both teams are out (and they've picked)
        const playerEliminated = !afcIsTBC && !nfcIsTBC && afcElim && nfcElim;

        const tr = document.createElement('tr');
        if (playerEliminated) tr.classList.add('player-eliminated');
        
        // Determine team display classes
        const afcClass = afcIsTBC ? 'team-tbc' : (afcElim ? 'team-eliminated' : 'team-alive');
        const nfcClass = nfcIsTBC ? 'team-tbc' : (nfcElim ? 'team-eliminated' : 'team-alive');

        tr.innerHTML = `
          <td>
            <div class="flex items-center gap-2 sm:gap-3">
              <img src="${p.avatar}" alt="${p.name}" 
                   class="w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover" />
              <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2">
                <span class="font-semibold text-sm sm:text-base">${p.name}</span>
                ${playerEliminated ? '<span class="eliminated-badge">Eliminated</span>' : ''}
              </div>
            </div>
          </td>
          <td>
            <div class="flex items-center justify-center gap-1 sm:gap-2">
              ${!afcIsTBC ? `<img src="Assets/teams/${slugifyTeam(afcTeam)}.png"
                    alt="${afcTeam} logo" 
                    class="w-5 h-5 sm:w-6 sm:h-6 team-logo-small object-contain" 
                    onerror="this.style.display='none'">` : ''}
              <span class="${afcClass} font-semibold text-xs sm:text-sm">
                ${afcTeam}
              </span>
            </div>
          </td>
          <td>
            <div class="flex items-center justify-center gap-1 sm:gap-2">
              ${!nfcIsTBC ? `<img src="Assets/teams/${slugifyTeam(nfcTeam)}.png"
                    alt="${nfcTeam} logo" 
                    class="w-5 h-5 sm:w-6 sm:h-6 team-logo-small object-contain" 
                    onerror="this.style.display='none'">` : ''}
              <span class="${nfcClass} font-semibold text-xs sm:text-sm">
                ${nfcTeam}
              </span>
            </div>
          </td>`;
        
        tbody.appendChild(tr);
      });

      // Hide loading, show table
      loadingState.classList.add('hidden');
      tableContainer.classList.remove('hidden');
    }

    // ============================================
    // HIGHLIGHT & HALL OF FAME
    // ============================================
   function applyHighlights(players, config, autoDetected) {
      const pIndex = indexBy(players);
      
      // Use auto-detected winner/spooner if available, otherwise fall back to config
      const winnerId = autoDetected?.winner?.id || config?.highlight?.winner;
      const spoonId = autoDetected?.spooner?.id || config?.highlight?.spoon;
      
      function setHighlight(role, id, teamOverride) {
        const elA = document.getElementById(role === 'winner' ? 'seasonWinnerAvatar' : 'seasonSpoonAvatar');
        const elN = document.getElementById(role === 'winner' ? 'seasonWinnerName' : 'seasonSpoonName');
        const elT = document.getElementById(role === 'winner' ? 'seasonWinnerTeam' : 'seasonSpoonTeam');
        
        if (!id) {
          if (elN) elN.textContent = 'TBD';
          if (elT) elT.textContent = 'â€”';
          return;
        }
        
        const p = pIndex.get(id);
        if (p) {
          if (elA) elA.src = p.avatar;
          if (elN) elN.textContent = p.name;
          if (elT) elT.textContent = teamOverride || p.team || '';
        }
      }
      
      setHighlight('winner', winnerId, autoDetected?.winningTeam);
      setHighlight('spoon', spoonId);

      // Hall of Fame
      const hof = document.getElementById('hallOfFame');
      if (hof) {
        hof.innerHTML = '';
        const validEntries = (config.honorary || []).filter(entry => entry.player);
        
        if (validEntries.length === 0) {
          hof.innerHTML = '<p class="text-white/50 text-sm col-span-full text-center py-4">No champions yet</p>';
          return;
        }
        
        validEntries.forEach(entry => {
          const p = pIndex.get(entry.player) || { name: entry.player, avatar: 'Assets/winnertbc.png' };
          const card = document.createElement('div');
          card.className = 'flex flex-col items-center gap-1 sm:gap-2 p-2 sm:p-3 text-center';
          card.innerHTML = `
            <img src="${p.avatar}" alt="${p.name}" 
                 class="ice-glow w-10 h-10 sm:w-14 sm:h-14 hof-avatar rounded-full object-cover"/>
            <div class="text-[10px] sm:text-xs text-white/70" style="font-family: Freshman">
              ${entry.year}
            </div>`;
          hof.appendChild(card);
        });
      }
    }
    
    // ============================================
    // INIT
    // ============================================
    async function init() {
      try {
        const [players, config, picks, espnData] = await Promise.all([
          fetchJson('players.json', fallbackPlayers),
          fetchJson('config.json', fallbackConfig),
          fetchPicksFromJsonBin(),
          fetchEliminatedTeams()
        ]);

        // Update status
        document.getElementById('lastUpdated').textContent = `Updated: ${espnData.lastUpdated}`;
        
        // Detect winner and spooner automatically
        const autoDetected = detectWinnerAndSpooner(
          players, 
          picks, 
          espnData.eliminated, 
          espnData.superBowlWinner
        );
        
        // Render prize pot or champion
        renderPrizePot(players, autoDetected.winner, autoDetected.winningTeam);
        
        // Render everything else
        applyHighlights(players, config, autoDetected);
        renderPicks(players, picks, espnData.eliminated);
        
      } catch (err) {
        console.error('Init error', err);
        document.getElementById('loadingState').innerHTML = `
          <p class="text-red-400">Error loading data. Please refresh.</p>
        `;
      }
    }

    // Auto-refresh every 5 minutes
    setInterval(async () => {
      const [players, picks, espnData] = await Promise.all([
        fetchJson('players.json', fallbackPlayers),
        fetchPicksFromJsonBin(),
        fetchEliminatedTeams()
      ]);
      
      document.getElementById('lastUpdated').textContent = `Updated: ${espnData.lastUpdated}`;
      
      const autoDetected = detectWinnerAndSpooner(
        players, 
        picks, 
        espnData.eliminated, 
        espnData.superBowlWinner
      );
      
      renderPrizePot(players, autoDetected.winner, autoDetected.winningTeam);
      renderPicks(players, picks, espnData.eliminated);
    }, 5 * 60 * 1000);

    document.addEventListener('DOMContentLoaded', init);
  </script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('âœ… Service Worker registered'))
      .catch(err => console.log('Service Worker error:', err));
  }
</script>
</body>
</html>
